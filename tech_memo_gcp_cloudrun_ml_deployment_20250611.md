# 🔧 2025-06-11 GCP Cloud RunにおけるAIモデルデプロイ技術メモ

## 1. **セッション全体の技術トピック一覧**
- Google Cloud Storage (GCS) バケットの作成と設定
- Cloud Runでの大規模AIモデル（LLM）のデプロイ戦略
- Dockerコンテナイメージサイズ制限への対応（モデル分離）
- Hugging Faceモデルファイルのダウンロードと管理
- `gsutil` コマンドラインツールの利用
- Google Cloud SDK のインストールと設定
- Cloud Runのコールドスタートとパフォーマンス最適化
- クラウドプロバイダ（AWS vs GCP）の比較（AI/ML、サーバーレス、コストの観点）
- GCP請求先アカウントのトラブルシューティング
- ナンバーレスカードでの本人確認
- GCP Compute Engine (VM) を利用した高速なモデルダウンロード・アップロード

## 2. **トピックごとの詳細解説**

### Google Cloud Storage (GCS) バケットの作成と設定

-   **ユーザーの初期疑問**
    - 「GCSバケットの準備」
    - 「region は単一で良いですか？」
    - 「この辺りの設定は？」 (GCSバケット作成時の詳細設定画面のスクリーンショットと共に)
-   **アシスタントの回答要約**
    GCSバケットは、モデルファイルのような大規模データを保存するためのストレージサービス。Cloud Runのデプロイリージョンに近い場所を選ぶことで、ネットワーク遅延と転送コストを最小限に抑えられる。無料枠は米国リージョンのみに限定されるが、Qwen2-Audioモデルのサイズ（16.8GB）では無料枠を超えるため、費用的なメリットは小さい。それよりも、Cloud Runと同じリージョンにGCSバケットを配置する「リージョン内のデータ転送の高速性」と「コストの安さ」を優先すべき。バケットのロケーションタイプは「単一リージョン（Regional）」で十分であり、ストレージクラスは「Standard」が推奨される。アクセス制御は「均一」に設定し、公開アクセスは防止する。
-   **発展的な話題・関連技術**
    - デュアルリージョン、マルチリージョンのストレージクラスの目的とコスト。
    - GCSのライフサイクル管理ポリシーによるオブジェクトの自動削除。
-   **重要な用語・背景知識**
    - **リージョン (Region)**: 特定の地理的場所（例: 東京、米国アイオワ）。
    - **アベイラビリティゾーン (Availability Zone)**: リージョン内の独立したデータセンター。
    - **Standard Storage Class**: 高頻度アクセス向けで低レイテンシ、高スループット。
    - **均一アクセス (Uniform access)**: バケット内のすべてのオブジェクトに同じIAMポリシーが適用されるアクセス制御方式。
-   **ユーザーが得た理解・気づき**
    - GCSバケットの無料枠が米国のみであることを認識。
    - 大規模モデルでは無料枠の恩恵が限定的であり、Cloud Runとのリージョン一致の方が性能とコストに優れることを理解。

### Cloud Runでの大規模AIモデル（LLM）のデプロイ戦略

-   **ユーザーの初期疑問**
    - 「モデルファイルを保存するためのGCSバケットを作成します。バケットのリージョンは、Cloud Runをデプロイするリージョンに近い場所を選ぶと、ネットワーク遅延と転送コストを最小限に抑えられます。」
    - 「コンテナに変えてから毎回デプロイするのは大変ではないですか？」 (プロンプトや推論パラメータ変更時)
    - 「デプロイって何度もするとお金はかかるのですか？」
    - 「CloudRun 自体は tokyo にした方が全然速さは違いますかね？」
-   **アシスタントの回答要約**
    Cloud Runに大規模なAIモデル（Qwen2-Audio-7B-Instruct: 16.8GB）をデプロイする場合、Cloud Runのコンテナイメージサイズ制限（約10GB）を超えるため、モデルファイルをコンテナイメージに含めることはできない。解決策として、モデルファイルをGCSに保存し、Cloud Runインスタンスの起動時（コールドスタート時）に `/tmp` ディレクトリにダウンロードしてロードする戦略が必須。この方法は、コンテナイメージを軽量に保ち、ビルド時間とArtifact Registryのストレージコストを削減できる。
    プロンプトや推論パラメータの変更については、毎回デプロイし直す手間を避けるため、環境変数としてコンテナに渡す方法、またはGCSに設定ファイルを置き、起動時に読み込む方法が推奨される。
    Cloud Runのデプロイ自体に直接的な費用は発生しないが、Cloud Build（ビルド時間）やArtifact Registry（イメージストレージ）、そしてインスタンスの起動・実行時間に間接的な費用が発生する。モデルをGCSに分離することで、これらの間接費用を抑えられる。
    ユーザーが日本にいる場合、Cloud Runを東京リージョン (`asia-northeast1`) にデプロイすることで、ユーザーからのリクエストに対するレイテンシが大幅に短縮され、API応答速度とユーザー体験が向上する。モデルダウンロードの速度も最適化されるため、GCSバケットも東京に配置すべき。
-   **発展的な話題・関連技術**
    - Cloud Runの自動スケーリング（min/max instances, scale-to-zero）。
    - `tmpfs` (RAMディスク) を利用した高速なモデルロード。
    - Cloud RunのCPUスロットリングとリクエスト並列処理。
-   **重要な用語・背景知識**
    - **コールドスタート (Cold Start)**: サーバーレス関数がリクエストがない状態から初めて起動する際の遅延。
    - **レイテンシ (Latency)**: リクエスト送信から応答受信までの時間遅延。
    - **Artifact Registry**: Dockerイメージなどのアーティファクトを保存するサービス。
    - **環境変数**: コンテナ実行時に外部から設定値を渡す方法。
-   **ユーザーが得た理解・気づき**
    - 大規模モデルのデプロイにおけるCloud Runのイメージサイズ制限を理解し、GCS分離が必須であることを認識。
    - プロンプトやパラメータの変更をデプロイなしで行う方法（環境変数、GCSファイル）の重要性を認識。
    - デプロイの費用構造を理解し、無料枠を超えても少額であること、モデル分離のメリットを認識。
    - ユーザーからの物理的距離がレイテンシに直結するため、Cloud Runのリージョン選択がユーザー体験に大きく影響することを理解。

### GCP請求先アカウントのトラブルシューティングと本人確認

-   **ユーザーの初期疑問**
    - 「この請求先アカウントは閉鎖されています。リンクされているプロジェクトを引き続き使用するには、このアカウントを再開してください。」というメッセージが表示された。
    - 「『請求先アカウントを再開』または同様のボタン/リンクがあるはずですが、このようなものはありません」
    - 「なぜか支払い方法を選択できないのはなぜですか？」 (支払い方法のポップアップのスクリーンショットと共に)
    - 「ナンバーレスカードなのですが．．．」
-   **アシスタントの回答要約**
    GCPの請求先アカウントが閉鎖されると、関連するプロジェクトのほとんど全てのサービスが利用できなくなる。主な原因は支払い方法の問題（有効期限切れ、限度額超過、引き落とし失敗）や、無料枠終了後の支払い設定未完了、または不正利用の疑い。
    「請求先アカウントを再開」ボタンが表示されない場合、深刻な問題（不正利用の疑い）でGoogle側が手動確認を求めている可能性が高い。提示されたスクリーンショットでは、支払い方法の確認が必要で、本人確認のために「カードの写真/コピー」と「政府機関発行の有効な写真付き身分証明書」のアップロードを求められている状況だった。
    ナンバーレスカードの場合は、物理カードの写真ではなく、カード発行会社のアプリやウェブサイトの画面（名前とカード番号が表示されている部分）のスクリーンショットを代替としてアップロードすることを推奨。この本人確認が完了すれば、請求先アカウントは再開される。
-   **発展的な話題・関連技術**
    - Google Cloud サポートへの問い合わせフロー。
    - GCPのセキュリティと不正防止システム。
-   **重要な用語・背景知識**
    - **請求先アカウント (Billing Account)**: GCPの利用料金が課金される単位。
    - **本人確認 (Identity Verification)**: アカウントの正当な所有者であることを確認するプロセス。
    - **ナンバーレスカード**: 物理カードにカード番号や有効期限が印字されていないクレジットカード。
-   **ユーザーが得た理解・気づき**
    - 請求先アカウントの閉鎖がGCP利用の致命的な障壁となることを認識。
    - サポート連絡の重要性と、具体的な問い合わせ方法を理解。
    - ナンバーレスカードでの本人確認の特殊な対応方法を理解し、問題を解決できた。

### GCP Compute Engine (VM) を利用した高速なモデルダウンロード・アップロード

-   **ユーザーの初期疑問**
    - 「この辺，アホみたいに時間かかってしんどいので，今後 GCP 上でダウンロードして，ストレージに保存するというアプローチはアリでしょうか？」
    - 「それでどれくらい時間がかかるのでしょうか？」
    - 「ああすみません，どれくらい値段かかるのでしょうか，」
-   **アシスタントの回答要約**
    大規模モデル（16.8GB）をローカルPCでダウンロード・アップロードするのは時間と手間がかかるため、GCPのCompute Engine (VM) インスタンスを一時的に利用して直接Hugging Faceからダウンロードし、GCSにアップロードするアプローチは非常に効率的で推奨される。
    VMは高速なネットワーク回線を持ち、ディスク容量の心配が少ないため、ダウンロードとGCSへの転送が圧倒的に速くなる。この作業にかかる時間は、VMの起動・設定を含めて全体で約30分〜1時間半程度が目安。
    費用は、VMのスペック（GPUなしが必須）、起動時間、ディスクサイズによるが、一時的な利用（数時間）であれば数十円〜数百円程度と非常に安価に抑えられる。作業完了後は必ずVMを停止または削除することで、不要な課金を防ぐことができる。
-   **発展的な話題・関連技術**
    - `gcloud auth login` と `gcloud config set project` によるCLI認証。
    - `gsutil -m cp -r` による並列・再帰的アップロード。
    - GCPの無料枠と課金モデルの詳細理解。
-   **重要な用語・背景知識**
    - **Compute Engine (GCE)**: GCPのIaaSサービスで、仮想マシンを提供する。
    - **`gsutil`**: Google Cloud Storageを操作するためのCLIツール。
    - **Ingress/Egress**: クラウドサービスへのデータ流入/流出。
-   **ユーザーが得た理解・気づき**
    - 大規模ファイルの取り扱いでGCP VMを一時的に活用するメリットを認識し、効率的な作業フローの選択肢を得た。
    - VM利用にかかる具体的な時間と費用の目安を把握し、導入へのハードルが下がった。

## 3. **総括**

このセッションでは、Qwen2-Audio-7B-InstructモデルのCloud Runへのデプロイという具体的な目標に対し、大規模モデルのコンテナイメージサイズ制限という主要な技術的障壁をGCSとの連携によって克服する設計方針を確立した。特に、GCSバケットのリージョン選定、Cloud Runのパフォーマンス最適化、そして何よりも利用開始の前提となるGCP請求先アカウントのトラブルシューティングと本人確認という、実務で頻繁に直面するが文書化されにくい初期設定の問題を深く掘り下げ、解決へと導いた。

ユーザーは、単なる技術コマンドの実行だけでなく、背後にあるクラウドのアーキテクチャ、コスト構造、そしてセキュリティとアカウント管理の重要性について、具体的な課題解決を通じて実践的な知見を得られた。「アホみたいに時間かかってしんどい」という率直な感情から、GCP上のVMを活用した効率的なアプローチへと視点が変化した点は、今後の開発において大きなプラスとなるだろう。今後は、確立したデプロイ戦略に基づき、モデルのダウンロードとコードの実装を進めていく。
